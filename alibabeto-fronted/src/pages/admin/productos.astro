---
import { type Producto } from '../../types/Productos'
import { type BasicResponse } from '../../types/API'
import { API } from '../../api/index'
import Dashboard from '../../components/Dashboard'
import Button from "../../components/BotonCrear.astro"


const user = Astro.locals.user;
console.log(user);

// if (!user) {
// 	return Astro.redirect("/login");
// }

const response = await fetch(`${API.dataUrl}/producto/query?`, {
    method: 'GET'
});

const { data }: BasicResponse<Producto[]> = await response.json();

// async function handleDelete(id: number) {
//     try {
//         const response = await fetch(`http://localhost:3000/producto/${id}`, {
//             method: 'DELETE',
//         });
//         if (response.ok) {
//             console.log('Producto eliminado correctamente');
//             window.location.reload(); // Recargar la página después de la eliminación
//         } else {
//             const errorData = await response.json();
//             console.error('Error al eliminar el producto:', errorData.msg);
//         }
//     } catch (error) {
//         console.error('Error de red:', error);
//     }
// }

---

<Dashboard/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="ml-auto mb-6 lg:w-[75%] xl:w-[80%] 2xl:w-[85%] p-10">
    <!-- esta linea hace las columnas las clases de tailwind -->
    <div style="margin-bottom: 10px;"></div>
    <div style="text-align: center; margin: 0 auto; width: 300px;">
      <a href="/admin/productos/create">
        <Button/>
      </a>
    </div>
  
   <section class="grid md:grid-cols-3 gap-5 my-10">
  <table style={{ borderCollapse: 'collapse', width: '100%' }}>
    <thead>
      <tr>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>id</th>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>CategoriaID</th>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>imagen</th>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>codigo</th>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>descripcion</th>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>precio</th>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>existencias </th>
        <th style={{ border: '1px solid #ddd', padding: '8px' }}>Acciones</th> {/* Añadido */}
      </tr>
    </thead>
    <tbody>
      {data?.map((producto: Producto) => (
        <tr key={producto.id}>
          {Object.values(producto).map((valor, index) => (
            <td key={index} style={{ border: '1px solid #ddd', padding: '8px' }}>
              {valor}
            </td>
          ))}
          <td style={{ border: '1px solid #ddd', padding: '8px' }}> {/* Añadido */}
            <button data-id={producto.id} class="deletes">Eliminar</button>
          </td>
        </tr>
      ))}
    </tbody>
  </table>
</section>

</div>

<script>

  const buttons = document.querySelectorAll(".deletes")

  
  async function handleDelete(id:any) {
    try {
      debugger
        const response = await fetch(`http://localhost:3000/producto/${id}`, {
            method: 'DELETE',
        });
        if (response.ok) {
            console.log('Producto eliminado correctamente');
            window.location.reload(); // Recargar la página después de la eliminación
        } else {
            const errorData = await response.json();
            console.error('Error al eliminar el producto:', errorData.msg);
        }
    } catch (error) {
        console.error('Error de red:', error);
    }

  }

  buttons.forEach( b => {
    b.addEventListener("click", () => handleDelete(b.getAttribute("data-id")) )
  })
</script>